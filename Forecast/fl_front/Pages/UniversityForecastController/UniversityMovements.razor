@page "/university-movements"
@using fl_front.Dtos.UniversityForecast
@using fl_front.Interfaces
@inject IUniversityForecastServiceF UniversityService

<h3>Movimientos de Insumos por Semestre</h3>

<div class="mb-3">
    <label class="form-label">ID de Semestre</label>
    <input class="form-control" @bind="semestreId" />
</div>

<button class="btn btn-primary mb-3" @onclick="CargarResumen">Buscar</button>

@if (resumen != null)
{
    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th>Insumo</th>
                <th>Total Movido</th>
                <th>Tipo Movimiento</th>
                <th>Responsable</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in resumen)
            {
                <tr>
                    <td>@item.Insumo</td>
                    <td>@item.CantidadTotal</td>
                    <td>@item.TipoMovimiento</td>
                    <td>@item.Responsable</td>
                    <td>
                        <button class="btn btn-sm btn-info" @onclick="() => VerDetalle(item.Insumo)">Ver Detalle</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (detalle != null && detalle.Count > 0)
{
    <h5>Detalle de: @detalleInsumo</h5>
    <table class="table table-sm">
        <thead>
            <tr>
                <th>Fecha Entregado</th>
                <th>Fecha Devuelto</th>
                <th>Cantidad</th>
                <th>Tipo Movimiento</th>
                <th>Responsable</th>
                <th>ID Solicitud</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var d in detalle)
            {
                <tr>
                    <td>@d.FechaEntregado.ToString("yyyy-MM-dd")</td>
                    <td>@(d.FechaDevuelto?.ToString("yyyy-MM-dd") ?? "–")</td>
                    <td>@d.Cantidad</td>
                    <td>@d.TipoMovimiento</td>
                    <td>@d.Responsable</td>
                    <td>@d.IdSolicitud</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private string semestreId = string.Empty;
    private List<MovimientoResumenDtoF>? resumen;
    private List<MovimientoDetalleDtoF>? detalle;
    private string? detalleInsumo;

    private async Task CargarResumen()
    {
        detalle = null;
        if (!string.IsNullOrWhiteSpace(semestreId))
        {
            resumen = await UniversityService.GetResumenPorSemestreAsync(semestreId);
        }
    }

    private async Task VerDetalle(string insumo)
    {
        detalleInsumo = insumo;
        detalle = await UniversityService.GetDetallePorInsumoAsync(insumo);
    }
}
